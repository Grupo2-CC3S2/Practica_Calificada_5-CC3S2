name: K8s Policies

on:
  push:
    branches: ["main", "develop", "feature/*"]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install kubeval
      run: |
        curl -LO https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar xf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin/

    - name: Install conftest
      run: |
        wget https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz
        tar xzf conftest_Linux_x86_64.tar.gz
        sudo mv conftest /usr/local/bin/

    - name: Kubeval validate
      run: kubeval k8s/**/*.yaml --strict

    - name: Conftest test
      run: conftest test k8s/
